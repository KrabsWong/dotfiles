# OPENSPEC:START
# OpenSpec shell completions configuration
fpath=("$HOME/.oh-my-zsh/custom/completions" $fpath)
autoload -Uz compinit
compinit
# OPENSPEC:END

# ═══════════════════════════════════════════════════════════════════════════
# Oh My Zsh Configuration
# ═══════════════════════════════════════════════════════════════════════════

# Check if Oh My Zsh is installed
if [[ -d "$HOME/.oh-my-zsh" ]]; then
    # Path to your Oh My Zsh installation.
    export ZSH="$HOME/.oh-my-zsh"

    # Set name of the theme to load --- if set to "random", it will
    # load a random theme each time Oh My Zsh is loaded, in which case,
    # to know which specific one was loaded, run: echo $RANDOM_THEME
    # See https://github.com/ohmyzsh/ohmyzsh/wiki/Themes
    ZSH_THEME="robbyrussell"

    # Uncomment the following line to use case-sensitive completion.
    # CASE_SENSITIVE="true"

    # Uncomment the following line to use hyphen-insensitive completion.
    # Case-sensitive completion must be off. _ and - will be interchangeable.
    # HYPHEN_INSENSITIVE="true"

    # Uncomment one of the following lines to change the auto-update behavior
    # zstyle ':omz:update' mode disabled  # disable automatic updates
    # zstyle ':omz:update' mode auto      # update automatically without asking
    # zstyle ':omz:update' mode reminder  # just remind me to update when it's time

    # Uncomment the following line to change how often to auto-update (in days).
    # zstyle ':omz:update' frequency 13

    # Uncomment the following line if pasting URLs and other text is messed up.
    # DISABLE_MAGIC_FUNCTIONS="true"

    # Uncomment the following line to disable colors in ls.
    # DISABLE_LS_COLORS="true"

    # Uncomment the following line to disable auto-setting terminal title.
    # DISABLE_AUTO_TITLE="true"

    # Uncomment the following line to enable command auto-correction.
    # ENABLE_CORRECTION="true"

    # Uncomment the following line to display red dots whilst waiting for completion.
    # You can also set it to another string to have that shown instead of the default red dots.
    # e.g. COMPLETION_WAITING_DOTS="%F{yellow}waiting...%f"
    # Caution: this setting can cause issues with multiline prompts in zsh < 5.7.1 (see #5765)
    # COMPLETION_WAITING_DOTS="true"

    # Uncomment the following line if you want to disable marking untracked files
    # under VCS as dirty. This makes repository status check for large repositories
    # much, much faster.
    # DISABLE_UNTRACKED_FILES_DIRTY="true"

    # Uncomment the following line if you want to change the command execution time
    # stamp shown in the history command output.
    # You can set one of the optional three formats:
    # "mm/dd/yyyy"|"dd.mm.yyyy"|"yyyy-mm-dd"
    # or set a custom format using the strftime function format specifications,
    # see 'man strftime' for details.
    # HIST_STAMPS="mm/dd/yyyy"

    # Would you like to use another custom folder than $ZSH/custom?
    # ZSH_CUSTOM=/path/to/new-custom-folder

    # Which plugins would you like to load?
    # Standard plugins can be found in $ZSH/plugins/
    # Custom plugins may be added to $ZSH_CUSTOM/plugins/
    # Example format: plugins=(rails git textmate ruby lighthouse)
    # Add wisely, as too many plugins slow down shell startup.
    plugins=(
      git
    )

    source $ZSH/oh-my-zsh.sh
fi

# ═══════════════════════════════════════════════════════════════════════════
# User Configuration
# ═══════════════════════════════════════════════════════════════════════════

# export MANPATH="/usr/local/man:$MANPATH"

# You may need to manually set your language environment
# export LANG=en_US.UTF-8

# Preferred editor for local and remote sessions
if [[ -n $SSH_CONNECTION ]]; then
  export EDITOR='vim'
else
  # Use neovim if available, otherwise vim
  if command -v nvim &> /dev/null; then
    export EDITOR='nvim'
  else
    export EDITOR='vim'
  fi
fi

# Compilation flags
# export ARCHFLAGS="-arch $(uname -m)"

# ═══════════════════════════════════════════════════════════════════════════
# Aliases
# ═══════════════════════════════════════════════════════════════════════════

# Set personal aliases, overriding those provided by Oh My Zsh libs,
# plugins, and themes. Aliases can be placed here, though Oh My Zsh
# users are encouraged to define aliases within a top-level file in
# the $ZSH_CUSTOM folder, with .zsh extension. Examples:
# - $ZSH_CUSTOM/aliases.zsh
# - $ZSH_CUSTOM/macos.zsh
# For a full list of active aliases, run `alias`.

# Editor aliases
if command -v nvim &> /dev/null; then
  alias vim="nvim"
fi

# Lazygit
if command -v lazygit &> /dev/null; then
  alias lg="lazygit"
fi

# LSD (modern ls replacement)
if command -v lsd &> /dev/null; then
  alias ls="lsd"
  alias ll="lsd -ltrh"
  alias la="lsd -ltrha"
fi

# Common aliases
alias cls="clear"

# ═══════════════════════════════════════════════════════════════════════════
# Git Configuration
# ═══════════════════════════════════════════════════════════════════════════

# Override the alias of oh-my-zsh/plugins/git/git.plugin.zsh
alias gb='git --no-pager branch'

# ═══════════════════════════════════════════════════════════════════════════
# Python Configuration
# ═══════════════════════════════════════════════════════════════════════════

# pip3 alias (only if pip3 exists)
if command -v pip3 &> /dev/null; then
  alias pip="pip3"
fi

# ═══════════════════════════════════════════════════════════════════════════
# Node.js / JavaScript Configuration
# ═══════════════════════════════════════════════════════════════════════════

# NVS (Node Version Switcher)
export NVS_HOME="$HOME/.nvs"
[ -s "$NVS_HOME/nvs.sh" ] && . "$NVS_HOME/nvs.sh"

# Node Max Old Space Size (Otherwise, it will become unhappy.)
export NODE_OPTIONS=--max_old_space_size=16384

# Bun
if [[ -d "$HOME/.bun" ]]; then
  export BUN_INSTALL="$HOME/.bun"
  export PATH="$BUN_INSTALL/bin:$PATH"
fi

# ═══════════════════════════════════════════════════════════════════════════
# Go Configuration
# ═══════════════════════════════════════════════════════════════════════════

# Go binaries
if [[ -d "$HOME/go/bin" ]]; then
  export PATH="$PATH:$HOME/go/bin"
fi

# ═══════════════════════════════════════════════════════════════════════════
# PyEnv Configuration
# ═══════════════════════════════════════════════════════════════════════════

if command -v pyenv &> /dev/null; then
  export PYENV_ROOT="$HOME/.pyenv"
  export PATH="$PYENV_ROOT/bin:$PATH"
  eval "$(pyenv init -)"
  if command -v pyenv-virtualenv-init &> /dev/null; then
    eval "$(pyenv virtualenv-init -)"
  fi
fi

# ═══════════════════════════════════════════════════════════════════════════
# Zsh Plugins (External)
# ═══════════════════════════════════════════════════════════════════════════

# zsh-autosuggestions (requires brew on macOS)
if command -v brew &> /dev/null; then
  local _autosuggestions_path="$(brew --prefix)/share/zsh-autosuggestions/zsh-autosuggestions.zsh"
  if [[ -f "$_autosuggestions_path" ]]; then
    source "$_autosuggestions_path"
  fi
fi

# ═══════════════════════════════════════════════════════════════════════════
# Tmux SSH Integration
# ═══════════════════════════════════════════════════════════════════════════

# Tmux Bottom Bar - Changes status bar color when SSH'd into a remote host
function ssh() {
    # Only run color logic in tmux environment
    if [ -n "$TMUX" ]; then
        # Extract hostname, display "Remote" if extraction fails
        local target_host=$(echo "$@" | grep -oE '[^ -][^ ]*$' | cut -d'@' -f2)
        [ -z "$target_host" ] && target_host="Remote"

        # Save current style for restoration (optional, can also use -u)
        # Change bottom bar to red, update right side
        tmux set status-style "bg=#ff5555,fg=white"
        tmux set status-right "#[fg=black,bg=#ffb86c,bold] REMOTE: $target_host #[fg=white,bg=#44475a,nobold] %H:%M "

        # Core: Use trap to catch exit signals
        # Restore on any exit (EXIT, INT, TERM)
        trap 'tmux set -u status-style; tmux set -u status-right; trap - EXIT INT TERM' EXIT INT TERM
    fi

    # Execute actual SSH
    # Use 'command' to call system binary, avoid infinite loop
    command ssh "$@"

    # Clean up signal trap on normal exit (though trap already handles EXIT)
    [ -n "$TMUX" ] && trap - EXIT INT TERM
}

# ═══════════════════════════════════════════════════════════════════════════
# Local Overrides
# ═══════════════════════════════════════════════════════════════════════════

# Load local machine-specific configuration if it exists
if [[ -f "$HOME/.zshrc.local" ]]; then
  source "$HOME/.zshrc.local"
fi
